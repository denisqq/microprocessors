.include "m8515def.inc"		;define ??? ATmega8515

	.EQU 	Frqnc = 4000000						;??????? ?? ? ??
	.EQU 	BaudRate = 19200					;???????? ????????  ?? UART
	.EQU 	Rate = Frqnc/(16*BaudRate)-1		;??????????? ????????? UBRR

	.EQU	BTNPORT	=PORTA
	.EQU	LEDPORT	=PORTB
	.EQU	BTNDDR	=DDRA
	.EQU	LEDDDR	=DDRB
	.EQU	BTNPIN	=PINA
	.EQU	LEDPIN	=PINB

	.DEF	BUF	=r16      ;*	r16 - ?????	
	.DEF	POS	=r17      ;r17 - ?????????? ???????????	
	.DEF	CURBTN	=r18  ;*	r18 - ????????? ??????
	.DEF	RUN1FLG	=r19  ;*	r19 - ???? 
	.DEF	RUN1CNT	=r20  ;*	r20 - ??????? ??????? ??? ??????? ???????????
	.DEF	NAMEFLG	=r21  ;*	r21 - ???? ????? 3
	.DEF	NAMECNT	=r22  ;*	r22 - ??????? ??????? ??? ????? 3
	.DEF	BAK1CNT	=r23  ;*	r23 - ???????? ????????? ??????? ??? ??????????? ??????? ???????
	.DEF	BAKFCNT	=r24  ;*	r24 - 		??? ????? ??????? ? ??????? ????????????
	.DEF	BAKSCNT	=r25  ;*	r25 - 		??? ????? ???????? ????????????
	.DEF	RUN1FLG2 =r26 ;*	r21 - ???? ???? ??????? ???????????? 

.CSEG    ;?????????? ??????? ? ?????? ???????? 

.ORG 0x0000
			RJMP	SETUP
.ORG OVF0addr
			RJMP	TIMER0_OF
.ORG URXCaddr			
			RJMP	USART_RX

;==========[[????????? ?????????? ???????????.]]=====================================================			
SETUP:		CLI									;?????? ??????????

;-----------|????????????? ?????|--------------------------------------------------------------------
			LDI		BUF,HIGH(RAMEND) 
            OUT		SPH,BUF          
            LDI		BUF,LOW(RAMEND) 
            OUT		SPL,BUF

;-----------|????????? ??????? ?????? (Idle)|--------------------------------------------------------
			IN		BUF,EMCUCR
			ANDI	BUF,0b01111111				;SM0<<0
			OUT		EMCUCR,BUF

			IN		BUF,MCUCR
			SBR		BUF,(1<<SE)
			ANDI	BUF,0b11101111				;SM1<<0
			OUT		MCUCR,BUF

			IN		BUF,MCUCSR
			SBR		BUF,0b11011111				;SM2<<0
			OUT		MCUCSR,BUF
			
			LDI		BUF,0b11111111
			OUT		LEDDDR,BUF					;????????? ?????? ?????? OUT

			LDI		BUF,0b00000000
			OUT		BTNDDR,BUF					;????????? ?????? ?????? IN

			LDI		RUN1CNT,0
			LDI		BAK1CNT,100
			LDI		BAKFCNT,100
			LDI		BAKSCNT,100

;-----------|????????? USART|------------------------------------------------------------------------
USART_SETUP:LDI		BUF,HIGH(Rate)
			OUT		UBRRH,BUF
			LDI		BUF,LOW(Rate)
			OUT		UBRRL,BUF
			
			LDI		BUF,(1<<RXCIE)|(1<<RXEN)|(1<<TXEN)   ;RXCE-h?????????? ?????????? ?? ?????????? ??????  RXEN-?????????? ?????? 
			                                             ; TXEN- ?????????? ????????
			OUT		UCSRB,BUF    ; ????????? ????? ? ???????  UCSRB

			LDI		BUF,(1<<UCSZ0)|(1<<UCSZ1)|(1<<URSEL)  ;UCSZ0,UCSZ1-??????????? ?????????? ??? ?????? ?? 8 ??? 
			                                              ;URSEL-???????? ??????? UCSRC, ? ?? UBRR
			OUT		UCSRC,BUF     ; ????????? ????? ? ???????  UCSRC

;-----------|????????? ??????? T0|-------------------------------------------------------------------
SETUP_T0:
			LDI		BUF,100						;255-124=131 // 255 = 1 ????, 125 ?????? ?? ????????????? // 16??? / 1024 = 15625??
			OUT		TCNT0,BUF                   ;??????? ??????? 

			LDI		BUF,0b00000010				;?. 258 TCCR0    //OCIE0 - ?????????? ?????????? ?? ?????????? 
			OUT 	TIMSK,BUF

			LDI		BUF,0b00000100				;?. 270 TCCR0    //????? ?????????????? 1024 
			OUT 	TCCR0,BUF

;-----------|????? ???????????? ????????? ?????? ??????????|------------------------------------------

			LDI		BUF,0
			LDI		POS,0
			LDI		CURBTN,0
			LDI		RUN1FLG,0
			LDI		RUN1CNT,0
			LDI		NAMEFLG,0
			LDI		RUN1FLG2,5
			LDI		NAMECNT,0
			LDI		BAK1CNT,0	
			LDI		BAKFCNT,0
			LDI		BAKSCNT,0

			SEI									;?????????? ??????????
;====================================================================================================

;==========[[???? ???.]]=============================================================================
MAIN:		SLEEP
			RJMP	MAIN
;====================================================================================================

;==========[[?????????? ?????????? ?? ??????? T0]]===================================================
;==========[[??????????? ?????? 10??]]===============================================================
TIMER0_OF:	LDI		BUF,100					;100 ~ 10ms 124 = 8ms
			OUT		TCNT0,BUF
			IN		CURBTN,BTNPIN   //??????????? ??????

			SBRC	CURBTN,0    //???? ?????? 1 ??????
			RJMP	PC+2;      //PC- 16 ???????(???????? ????? ???????,??????? ??????, ????? ?????????? ??????????? ??????? ) 
			RCALL	SET_1      //???????? ?????? ????????? ??? ????????? ???????????

			SBRC	CURBTN,1   //???? ?????? 2 ??????
			RJMP	PC+2;
			RCALL	SET_2     //???????? ?????? ????????? ??? ????????? ???????????

			SBRC	CURBTN,2   //???? ?????? 3 ??????
			RJMP	PC+5;
			CPI		BAK1CNT,100   //??????? ??????? ??? ???????
			BRLO	PC+3
			RCALL	START_RUN_1    //??????? ???????????? 
			LDI		BAK1CNT,0      //????????? ???????? 

			SBRC	CURBTN,3      //???? ?????? 4 ??????
			RJMP	PC+5;
			CPI		BAKFCNT,100   //??????? ??????? ??? ?????
			BRLO	PC+3
			RCALL	F_NAME        //????? ????? ??????? ???????????? 
			LDI		BAKFCNT,0     //????????? ???????? 

			SBRC	CURBTN,4      //???? ?????? 5 ??????
			RJMP	PC+5;
			CPI		BAKFCNT,100   //??????? ??????? ??? ?????
			BRLO	PC+3
			RCALL	F_NAME2       //????? ????? ??????? ????????????
			LDI		BAKFCNT,0     //????????? ???????? 

			SBRC	CURBTN,5      //???? ?????? 6 ??????
			RJMP	PC+5;
			CPI		BAKSCNT,100   //??????? ??????? ??? ?????
			BRLO	PC+3
			RCALL	START_S_NAME    //????? ????? ???????? ????????????
			LDI		BAKSCNT,0       //????????? ????????

			CPI		RUN1FLG,1    //???????? ????? ???? ?????????? ? ???????
			BRNE	PC+2;
			RCALL	RUN_1        //????? ???????
			CPI		NAMEFLG,1    //???????? ????? ???? ?????????? ? ???????
			BRNE	PC+2;
			RCALL	S_NAME       //?????? ?????
			CPI		BAK1CNT,100  //???????? ???????? 
			BRSH	PC+2         //??????? ???? ????? ??? ??????
			INC		BAK1CNT      //????????? ????????
			CPI		BAKFCNT,100
			BRSH	PC+2          //??????? ???? ????? ??? ??????
			INC		BAKFCNT
			CPI		BAKSCNT,100
			BRSH	PC+2          //??????? ???? ????? ??? ??????
			INC		BAKSCNT
END:		RETI
;====================================================================================================




;==========[[?????? ?????????]]===========================================================
SET_1:
			LDI		RUN1FLG,0
			LDI		POS,170    ;01010101
			COM		POS         //?????????? ?? ???????
			OUT		LEDPORT,POS  //????? ?? ???? 
			COM		POS          //?????????? ?? ???????
			//LDI		RUN1CNT,0
			LDI		RUN1FLG2,0  //????????? ????? ??? ??????? 
			RET
;==========[[?????? ????????? ]]===========================================================
SET_2:
			LDI		RUN1FLG,0
			LDI		POS,85     ;10101010
			COM		POS
			OUT		LEDPORT,POS
			COM		POS
			LDI		RUN1CNT,0
			LDI		RUN1FLG2,1
			RET

;==========[[?????? ??????? ???????.]]======================================================================
START_RUN_1:
			LDI		RUN1FLG,1  //????????? ??????
			LDI		RUN1CNT,0
			RET

;==========[[??????? ????????????.]]======================================================================
RUN_1:
            
            CPI		RUN1CNT,20	;RUN1CNT - ??????? ???????
			CPI    RUN1FLG2,0   //???? ???? ????? 0
			breq p1             // ??????? ? ????????? ?1

			CPI    RUN1FLG2,1   //???? ???? ????? 1
			breq p2             // ??????? ? ????????? ?2
		

p1:	        CPI		RUN1CNT,75					;RUN1CNT - ??????? ???????
			BRNE	STAGE0                      //??????? ? 0
			LDI		RUN1CNT,0                   //???????? ??????? 
STAGE0:		CPI		RUN1CNT,0                   //???? ??????? ????? 0

			BRNE	STAGE4                      //????????? ?? 4 

			CPI		POS,85						;???? POS = 10101010b,
			BRNE	STAGE1							;=>?????: ????????? ?? 1 
			RJMP	STAGE3                          ;??: ????????? ?? 3 

	
STAGE1:		CPI		POS,0						;????? ???? POS = 00000000b
			BRNE	STAGE2							;=> (????????? ?? 2)
			LDI		POS,170				;?? POS = 01010101b
			RJMP	STAGE3							;=> (????? ????? ?? ????)
STAGE2:		LDI		BUF,0						;?????
			MUL		POS,BUF						;r0 = POS*BUF
			MOV		POS,r0						;POS = r0
STAGE3:		COM		POS
			OUT		LEDPORT,POS					;????? POS ?? ???? ???????????
			COM		POS
STAGE4:		INC		RUN1CNT                     //????????????? ???????

            RET	    

p2:		    CPI		RUN1CNT,75					;RUN1CNT - ??????? ???????
			BRNE	STAGE5                       //??????? ? 5
			LDI		RUN1CNT,0                     //???????? ??????? 
STAGE5:		CPI		RUN1CNT,0                     //???? ??????? ????? 0

			BRNE	STAGE9                         // ??: ??????? ? 9

			CPI		POS,170						;???? POS = 01010101b,
			BRNE	STAGE6							;=> (????? ????????? ? 6)
			RJMP	STAGE8                          ; ??: ????????? ? 8 

	
STAGE6:		CPI		POS,0						;????? ???? POS = 00000000b
			BRNE	STAGE7							;=> (????? ??????? ?? 7 )
			LDI		POS,85				        ;?? POS = 10101010b
			RJMP	STAGE3							;=> (????? ????? ?? ????)
STAGE7:		LDI		BUF,0						;?????
			MUL		POS,BUF						;r0 = POS*BUF
			MOV		POS,r0						;POS = r0
STAGE8:		COM		POS
			OUT		LEDPORT,POS					;????? POS ?? ???? ???????????
			COM		POS
STAGE9:		INC		RUN1CNT                     //????????????? ???????


            RET	
		
;====================================================================================================

;==========[[???????? ?? USART]]=====================================================================
USART_TX:	CLI    //?????????? ?????? ?????????? 
			OUT		UDR,BUF
			SBIS	UCSRA,UDRE     //???? ??? ?????????? ?????????? ????????? ??????? UDRE_???? ??????????? ???????? ???????????
			                       //1-???? ????? ?????? 
			RJMP	PC-1
			SEI    //?????????? ?????????? ??????????
			RET
;====================================================================================================

;==========[[????? ?? USART]]========================================================================
USART_RX:	CLI     //?????????? ?????? ?????????? 
			IN		BUF,UDR
			
			CPI		BUF,78  //?????? "N" ?? ??????????
			BRNE	PC+2;
			RCALL	F_NAME  //????? ????? 1 
			CPI		BUF,76   //?????? "L" ?? ??????????
			BRNE	PC+2;
			RCALL	F_NAME2   //????? ????? 2
			CPI		BUF,83    //?????? "S" ?? ??????????
			BRNE	PC+2;
			RCALL	START_S_NAME   //????? ????? 3
			SEI     //?????????? ?????????? ??????????
			RETI
;====================================================================================================

;==========[[???????? ????? ???????????? 1]]=========================================================
F_NAME:		

			LDI		BUF,78						;N
			RCALL	USART_TX
			LDI		BUF,97						;a
			RCALL	USART_TX
	        LDI		BUF,100						;d
			RCALL	USART_TX
			LDI		BUF,121						;y
			RCALL	USART_TX
			LDI		BUF,97						;a
			RCALL	USART_TX
			LDI		BUF,13						;CR    //??????? ??????? 
			RCALL	USART_TX
			LDI		BUF,10						;LF    //??????? ??????
			RCALL	USART_TX
			RET
;====================================================================================================
;==========[[???????? ????? ???????????? 2]]=========================================================
F_NAME2:	LDI		BUF,76						;L
			RCALL	USART_TX
			LDI		BUF,101						;e
			RCALL	USART_TX
			LDI		BUF,118						;v
			RCALL	USART_TX
			
			LDI		BUF,13						;CR
			RCALL	USART_TX
			LDI		BUF,10						;LF
			RCALL	USART_TX
			RET
;====================================================================================================

;==========[[?????? ??? ???????????? 3]]=============================================================
START_S_NAME:
			LDI		NAMEFLG,1         //????????? ?????? 
			LDI		NAMECNT,0
			RET
;====================================================================================================

;==========[[???????? ????? ???????????? 3]]=========================================================
S_NAME:		CPI		NAMECNT,0xC8				;NAMECNT - ??????? ???????
			BRNE	PC+2
			LDI		NAMECNT,0
			CPI		NAMECNT,0
			BRNE	END_S_NAME
			LDI		BUF,83						;S
			RCALL	USART_TX
			LDI		BUF,101						;e
			RCALL	USART_TX
			LDI		BUF,114					    ;r
			RCALL	USART_TX
			LDI		BUF,103						;g
			RCALL	USART_TX
			LDI		BUF,101						;e
			RCALL	USART_TX
			LDI		BUF,121						;y
			RCALL	USART_TX
			LDI		BUF,9					;CR
			RCALL	USART_TX
			LDI		BUF,32					;??????
			RCALL	USART_TX
END_S_NAME:	INC		NAMECNT
			RET
;====================================================================================================
